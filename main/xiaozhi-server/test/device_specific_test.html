<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小智设备专项测试页面</title>
    
    <!-- 添加favicon -->
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
    
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }

        .device-selector {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .device-selector h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
        }

        .device-input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .device-input-group label {
            font-weight: 500;
            min-width: 80px;
        }

        .device-input-group input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }

        .device-input-group button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .device-input-group button:hover {
            background: white;
            color: #f5576c;
        }

        .status-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #007bff;
        }

        .status-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
        }

        .status-label {
            font-weight: 500;
            color: #666;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: #28a745;
        }

        .status-offline {
            background-color: #dc3545;
        }

        .status-unknown {
            background-color: #ffc107;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .test-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .test-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .test-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .test-btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .test-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }

        .test-btn-secondary {
            background: linear-gradient(135deg, #6c757d, #545b62);
            color: white;
        }

        .test-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .test-btn-danger {
            background: linear-gradient(135deg, #dc3545, #b21e2f);
            color: white;
        }

        .test-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .test-results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #dee2e6;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .log-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }

        .log-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .log-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .log-error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .audio-player {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .device-info-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .device-info-card h3 {
            margin: 0 0 15px 0;
        }

        .device-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .device-detail {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
        }

        .device-detail-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .device-detail-value {
            font-weight: 600;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🤖 小智设备专项测试</h1>
        
        <!-- 设备选择器 -->
        <div class="device-selector">
            <h2>🔍 设备选择</h2>
            <div class="device-input-group">
                <label for="deviceMac">设备MAC:</label>
                <input type="text" id="deviceMac" placeholder="例如: 24:0A:C4:1D:3B:F0" 
                       pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                <button onclick="connectToDevice()">连接设备</button>
                <button onclick="clearDevice()">清除</button>
            </div>
        </div>

        <!-- 连接配置 -->
        <div class="device-selector" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <h2>⚙️ 连接配置</h2>
            <div class="device-input-group">
                <label for="configHost">服务器地址:</label>
                <input type="text" id="configHost" placeholder="20.64.152.107" style="min-width: 150px;">
                <label for="configWsPort">WS端口:</label>
                <input type="text" id="configWsPort" placeholder="8000" style="min-width: 80px;">
                <label for="configHttpPort">HTTP端口:</label>
                <input type="text" id="configHttpPort" placeholder="8002" style="min-width: 80px;">
                <button onclick="updateConnectionConfig()">应用配置</button>
            </div>
            <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                当前WebSocket: <span id="currentWsUrl">--</span> | HTTP API: <span id="currentHttpUrl">--</span>
            </div>
        </div>

        <!-- 设备信息卡片 -->
        <div id="deviceInfoCard" class="device-info-card hidden">
            <h3>📱 设备信息</h3>
            <div class="device-details">
                <div class="device-detail">
                    <div class="device-detail-label">MAC地址</div>
                    <div class="device-detail-value" id="deviceMacDisplay">--</div>
                </div>
                <div class="device-detail">
                    <div class="device-detail-label">连接状态</div>
                    <div class="device-detail-value" id="deviceStatus">
                        <span class="status-indicator status-unknown"></span>未知
                    </div>
                </div>
                <div class="device-detail">
                    <div class="device-detail-label">固件版本</div>
                    <div class="device-detail-value" id="deviceVersion">--</div>
                </div>
                <div class="device-detail">
                    <div class="device-detail-label">最后活跃</div>
                    <div class="device-detail-value" id="deviceLastSeen">--</div>
                </div>
            </div>
        </div>

        <!-- 状态监控 -->
        <div class="status-section">
            <div class="status-card">
                <h3>🌐 服务器状态</h3>
                <div class="status-info">
                    <span class="status-label">WebSocket:</span>
                    <span class="status-value" id="wsStatus">
                        <span class="status-indicator status-offline"></span>断开
                    </span>
                </div>
                <div class="status-info">
                    <span class="status-label">HTTP API:</span>
                    <span class="status-value" id="httpStatus">
                        <span class="status-indicator status-unknown"></span>未知
                    </span>
                </div>
                <div class="status-info">
                    <span class="status-label">服务器时间:</span>
                    <span class="status-value" id="serverTime">--</span>
                </div>
            </div>

            <div class="status-card">
                <h3>📊 设备状态</h3>
                <div class="status-info">
                    <span class="status-label">连接时长:</span>
                    <span class="status-value" id="connectionDuration">--</span>
                </div>
                <div class="status-info">
                    <span class="status-label">消息发送:</span>
                    <span class="status-value" id="messagesSent">0</span>
                </div>
                <div class="status-info">
                    <span class="status-label">消息接收:</span>
                    <span class="status-value" id="messagesReceived">0</span>
                </div>
            </div>
        </div>

        <!-- TTS测试 -->
        <div class="test-section">
            <h3>🎵 TTS语音合成测试</h3>
            <div class="test-controls">
                <button class="test-btn test-btn-primary" onclick="testTTS()">基础TTS测试</button>
                <button class="test-btn test-btn-primary" onclick="testCosyVoiceClone()">CosyVoice克隆测试</button>
                <button class="test-btn test-btn-secondary" onclick="testCustomText()">自定义文本测试</button>
                <button class="test-btn test-btn-danger" onclick="clearTTSResults()">清除结果</button>
            </div>
            <div>
                <label for="customTTSText">自定义测试文本:</label>
                <input type="text" id="customTTSText" placeholder="输入要测试的文本..." style="width: 100%; margin: 10px 0; padding: 8px;">
            </div>
            <div class="test-results" id="ttsResults">
                <div class="log-info">等待测试...</div>
            </div>
            <div class="audio-controls hidden" id="audioControls">
                <label>生成的音频:</label>
                <audio class="audio-player" id="audioPlayer" controls></audio>
                <button class="test-btn test-btn-secondary" onclick="downloadAudio()">下载音频</button>
            </div>
        </div>

        <!-- 设备通信测试 -->
        <div class="test-section">
            <h3>📡 设备通信测试</h3>
            <div class="test-controls">
                <button class="test-btn test-btn-primary" onclick="testDevicePing()">连接测试</button>
                <button class="test-btn test-btn-primary" onclick="testDeviceWakeup()">唤醒测试</button>
                <button class="test-btn test-btn-secondary" onclick="testDeviceRestart()">重启设备</button>
                <button class="test-btn test-btn-danger" onclick="clearCommResults()">清除结果</button>
            </div>
            <div class="test-results" id="commResults">
                <div class="log-info">等待测试...</div>
            </div>
        </div>

        <!-- 完整功能测试 -->
        <div class="test-section">
            <h3>🚀 完整功能测试</h3>
            <div class="test-controls">
                <button class="test-btn test-btn-primary" onclick="runFullTest()">运行完整测试</button>
                <button class="test-btn test-btn-secondary" onclick="exportTestReport()">导出测试报告</button>
                <button class="test-btn test-btn-danger" onclick="clearAllResults()">清除所有结果</button>
            </div>
            <div class="test-results" id="fullTestResults">
                <div class="log-info">等待测试...</div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let websocket = null;
        let currentDevice = null;
        let testResults = {
            tts: [],
            communication: [],
            full: []
        };
        let connectionStartTime = null;
        let messagesSent = 0;
        let messagesReceived = 0;
        let pingInterval = null; // 保活定时器

    // ===================== 可配置连接参数 =====================
    // 通过 URL 参数自定义: ?host=20.64.152.107&ws_port=8000&http_port=8002
    // 也可直接传完整 ws 基础地址: ?ws_base=ws://example.com:8001/xiaozhi/v1/
    // 如果既传 ws_base 也传 host/ws_port，则优先使用 ws_base
    const pageParams = new URLSearchParams(window.location.search);
    const DEFAULT_HOST = window.location.hostname || '20.64.152.107';
    const HOST = pageParams.get('host') || DEFAULT_HOST;
    const WS_PORT = pageParams.get('ws_port') || '8000'; // 直连后端默认 8000; 若走 nginx 可改 8001
    const HTTP_PORT = pageParams.get('http_port') || '8002'; // manager-api / 或 nginx 端口
    const WS_BASE = pageParams.get('ws_base') || `ws://${HOST}:${WS_PORT}/xiaozhi/v1/`;
    const HTTP_API_BASE = pageParams.get('http_base') || `http://${HOST}:${HTTP_PORT}`;
    // 当前实际使用的 WebSocket 完整地址在建立连接时拼接 device-id & client-id 查询参数
    // ==========================================================

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeUI();
            initializeConnectionConfig();
            checkServerStatus();
            
            // 从URL参数中获取MAC地址
            const urlParams = new URLSearchParams(window.location.search);
            const macParam = urlParams.get('mac');
            if (macParam) {
                document.getElementById('deviceMac').value = macParam;
                connectToDevice();
            }
        });

        function initializeUI() {
            // 设置实时时间更新
            setInterval(updateServerTime, 1000);
            
            // 监听MAC地址输入格式化
            const macInput = document.getElementById('deviceMac');
            macInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9A-Fa-f]/g, '');
                let formatted = value.match(/.{1,2}/g)?.join(':') || value;
                if (formatted.length <= 17) {
                    e.target.value = formatted.toUpperCase();
                }
            });
        }

        function initializeConnectionConfig() {
            // 设置默认配置
            document.getElementById('configHost').value = HOST;
            document.getElementById('configWsPort').value = WS_PORT;
            document.getElementById('configHttpPort').value = HTTP_PORT;
            
            // 更新显示
            updateConnectionConfigDisplay();
        }

        function updateConnectionConfig() {
            const newHost = document.getElementById('configHost').value.trim() || HOST;
            const newWsPort = document.getElementById('configWsPort').value.trim() || WS_PORT;
            const newHttpPort = document.getElementById('configHttpPort').value.trim() || HTTP_PORT;
            
            // 更新全局变量（重新赋值常量）
            window.CURRENT_HOST = newHost;
            window.CURRENT_WS_PORT = newWsPort;
            window.CURRENT_HTTP_PORT = newHttpPort;
            window.CURRENT_WS_BASE = `ws://${newHost}:${newWsPort}/xiaozhi/v1/`;
            window.CURRENT_HTTP_API_BASE = `http://${newHost}:${newHttpPort}`;
            
            updateConnectionConfigDisplay();
            addLog('commResults', `连接配置已更新: WS=${newHost}:${newWsPort}, HTTP=${newHost}:${newHttpPort}`, 'success');
        }

        function updateConnectionConfigDisplay() {
            const wsBase = window.CURRENT_WS_BASE || WS_BASE;
            const httpBase = window.CURRENT_HTTP_API_BASE || HTTP_API_BASE;
            document.getElementById('currentWsUrl').textContent = wsBase;
            document.getElementById('currentHttpUrl').textContent = httpBase;
        }

        function updateServerTime() {
            const now = new Date();
            document.getElementById('serverTime').textContent = now.toLocaleString();
        }

        function addLog(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        async function checkServerStatus() {
            try {
                const httpBase = window.CURRENT_HTTP_API_BASE || HTTP_API_BASE;
                const response = await fetch(`${httpBase}/xiaozhi/health`);
                if (response.ok) {
                    updateStatus('httpStatus', '在线', 'online');
                } else {
                    updateStatus('httpStatus', '错误', 'offline');
                }
            } catch (error) {
                updateStatus('httpStatus', '离线', 'offline');
            }
        }

        function updateStatus(elementId, text, status) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            
            element.innerHTML = `<span class="status-indicator status-${status}"></span>${text}`;
        }

        function connectToDevice() {
            const macAddress = document.getElementById('deviceMac').value.trim();
            
            if (!macAddress) {
                alert('请输入设备MAC地址');
                return;
            }

            if (!isValidMacAddress(macAddress)) {
                alert('请输入有效的MAC地址格式 (例如: 24:0A:C4:1D:3B:F0)');
                return;
            }

            currentDevice = {
                mac: macAddress,
                status: 'connecting'
            };

            // 显示设备信息卡片
            showDeviceInfo();
            
            // 建立WebSocket连接
            connectWebSocket();
            
            addLog('commResults', `开始连接设备: ${macAddress}`, 'info');
        }

        function isValidMacAddress(mac) {
            const macPattern = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
            return macPattern.test(mac);
        }

        function showDeviceInfo() {
            const card = document.getElementById('deviceInfoCard');
            card.classList.remove('hidden');
            
            document.getElementById('deviceMacDisplay').textContent = currentDevice.mac;
            updateStatus('deviceStatus', '连接中...', 'unknown');
        }

        function connectWebSocket() {
            if (websocket) {
                clearPingKeepAlive(); // 清理之前的定时器
                websocket.close();
            }
            
            // 生成 client-id（避免重复）
            const clientId = `web_${Date.now().toString(36)}`;
            // 使用当前配置的地址
            const wsBase = window.CURRENT_WS_BASE || WS_BASE;
            // 必须携带 device-id 与 client-id 查询参数，否则服务器会立即关闭连接
            const fullWsUrl = `${wsBase}?device-id=${encodeURIComponent(currentDevice.mac)}&client-id=${encodeURIComponent(clientId)}`;
            addLog('commResults', `尝试连接: ${fullWsUrl}`, 'info');
            try {
                websocket = new WebSocket(fullWsUrl);
            } catch (e) {
                addLog('commResults', `创建WebSocket失败: ${e.message}`, 'error');
                updateStatus('wsStatus', '错误', 'offline');
                return;
            }
            connectionStartTime = new Date();

            websocket.onopen = function() {
                updateStatus('wsStatus', '已连接', 'online');
                addLog('commResults', 'WebSocket连接成功', 'success');
                
                // 发送标准 hello 消息（模拟真实设备行为）
                sendHelloMessage();
                
                // 启动定时 ping 保活
                startPingKeepAlive();
            };

            websocket.onmessage = function(event) {
                messagesReceived++;
                document.getElementById('messagesReceived').textContent = messagesReceived;
                
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    addLog('commResults', `消息解析错误: ${error.message}`, 'error');
                }
            };

            websocket.onclose = function(event) {
                updateStatus('wsStatus', '已断开', 'offline');
                updateStatus('deviceStatus', '离线', 'offline');
                
                // 显示详细的关闭信息
                const closeReason = getCloseReason(event.code);
                addLog('commResults', `WebSocket连接断开 - 代码: ${event.code}, 原因: ${closeReason}`, 'warning');
                if (event.reason) {
                    addLog('commResults', `服务器消息: ${event.reason}`, 'info');
                }
                
                // 清理定时器
                clearPingKeepAlive();
            };

            websocket.onerror = function(error) {
                addLog('commResults', `WebSocket错误: ${error}`, 'error');
                updateStatus('wsStatus', '错误', 'offline');
            };
        }

        function sendDeviceAuth() {
            const authMessage = {
                type: 'device_auth',
                mac: currentDevice.mac,
                timestamp: Date.now()
            };
            
            sendWebSocketMessage(authMessage);
            addLog('commResults', '发送设备认证请求', 'info');
        }

        function sendHelloMessage() {
            const helloMessage = {
                type: 'hello',
                device_id: currentDevice.mac,
                device_name: 'Web测试设备',
                device_mac: currentDevice.mac,
                token: 'your-token1',
                features: { mcp: true }
            };
            
            if (sendWebSocketMessage(helloMessage)) {
                addLog('commResults', '发送hello初始化消息', 'success');
            }
        }

        function startPingKeepAlive() {
            // 每30秒发送一次ping保活
            pingInterval = setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    const pingMessage = {
                        type: 'ping',
                        timestamp: Date.now()
                    };
                    sendWebSocketMessage(pingMessage);
                    addLog('commResults', '发送ping保活', 'info');
                }
            }, 30000);
        }

        function clearPingKeepAlive() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }

        function getCloseReason(code) {
            const reasons = {
                1000: '正常关闭',
                1001: '端点离开',
                1002: '协议错误',
                1003: '不支持的数据类型',
                1005: '没有状态码',
                1006: '异常关闭',
                1007: '无效数据',
                1008: '违反策略',
                1009: '消息过大',
                1010: '扩展错误',
                1011: '服务器错误',
                1012: '服务重启',
                1013: '稍后重试',
                1014: '网关错误',
                1015: 'TLS握手失败'
            };
            return reasons[code] || `未知错误码: ${code}`;
        }

        function sendWebSocketMessage(message) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify(message));
                messagesSent++;
                document.getElementById('messagesSent').textContent = messagesSent;
                return true;
            } else {
                addLog('commResults', 'WebSocket未连接，无法发送消息', 'error');
                return false;
            }
        }

        function handleWebSocketMessage(data) {
            addLog('commResults', `收到消息: ${JSON.stringify(data)}`, 'info');
            
            switch (data.type) {
                case 'device_auth_response':
                    if (data.success) {
                        updateStatus('deviceStatus', '已认证', 'online');
                        currentDevice.status = 'authenticated';
                        addLog('commResults', '设备认证成功', 'success');
                    } else {
                        updateStatus('deviceStatus', '认证失败', 'offline');
                        addLog('commResults', `设备认证失败: ${data.message}`, 'error');
                    }
                    break;
                    
                case 'device_info':
                    updateDeviceInfo(data);
                    break;
                    
                case 'tts_response':
                    handleTTSResponse(data);
                    break;

                case 'welcome':
                case 'session_start':
                    updateStatus('deviceStatus', '会话已建立', 'online');
                    addLog('commResults', '收到欢迎消息，会话建立成功', 'success');
                    break;

                case 'pong':
                    addLog('commResults', '收到pong响应', 'info');
                    break;

                case 'mcp':
                    // 处理MCP消息
                    handleMCPMessage(data);
                    break;
                    
                default:
                    addLog('commResults', `收到消息类型: ${data.type}`, 'info');
            }
        }

        function handleMCPMessage(data) {
            addLog('commResults', '收到MCP消息，发送响应', 'info');
            
            if (data.payload && data.payload.method) {
                switch (data.payload.method) {
                    case 'initialize':
                        // 响应初始化
                        const initResponse = {
                            type: 'mcp',
                            payload: {
                                jsonrpc: '2.0',
                                id: data.payload.id,
                                result: {
                                    protocolVersion: '2024-11-05',
                                    capabilities: {
                                        tools: {},
                                        resources: {},
                                        prompts: {}
                                    },
                                    serverInfo: {
                                        name: 'WebTestDevice',
                                        version: '1.0.0'
                                    }
                                }
                            }
                        };
                        sendWebSocketMessage(initResponse);
                        addLog('commResults', '已响应MCP初始化', 'success');
                        break;

                    case 'tools/list':
                        // 返回设备支持的工具列表
                        const toolsResponse = {
                            type: 'mcp',
                            payload: {
                                jsonrpc: '2.0',
                                id: data.payload.id,
                                result: {
                                    tools: [
                                        {
                                            name: 'self.get_device_status',
                                            description: '获取设备状态信息',
                                            inputSchema: {
                                                type: 'object',
                                                properties: {}
                                            }
                                        },
                                        {
                                            name: 'self.audio_speaker_set_volume',
                                            description: '设置音量',
                                            inputSchema: {
                                                type: 'object',
                                                properties: {
                                                    volume: {
                                                        type: 'number',
                                                        description: '音量值 0-100'
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        };
                        sendWebSocketMessage(toolsResponse);
                        addLog('commResults', '已响应工具列表', 'success');
                        updateStatus('deviceStatus', '已连接', 'online');
                        break;

                    default:
                        addLog('commResults', `未处理的MCP方法: ${data.payload.method}`, 'warning');
                }
            }
        }

        function updateDeviceInfo(data) {
            if (data.version) {
                document.getElementById('deviceVersion').textContent = data.version;
            }
            if (data.lastSeen) {
                document.getElementById('deviceLastSeen').textContent = new Date(data.lastSeen).toLocaleString();
            }
            
            // 更新连接时长
            if (connectionStartTime) {
                const duration = Math.floor((Date.now() - connectionStartTime.getTime()) / 1000);
                document.getElementById('connectionDuration').textContent = formatDuration(duration);
            }
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}小时${minutes}分${secs}秒`;
            } else if (minutes > 0) {
                return `${minutes}分${secs}秒`;
            } else {
                return `${secs}秒`;
            }
        }

        async function testTTS() {
            addLog('ttsResults', '开始基础TTS测试...', 'info');
            
            const testTexts = [
                '你好，我是小智助手',
                '今天天气很好',
                '语音合成测试成功'
            ];
            
            for (let i = 0; i < testTexts.length; i++) {
                const text = testTexts[i];
                addLog('ttsResults', `测试文本 ${i + 1}: "${text}"`, 'info');
                
                try {
                    const result = await performTTSRequest(text, 'basic');
                    if (result.success) {
                        addLog('ttsResults', `✅ 文本 ${i + 1} 合成成功`, 'success');
                        if (result.audioUrl) {
                            showAudioPlayer(result.audioUrl);
                        }
                    } else {
                        addLog('ttsResults', `❌ 文本 ${i + 1} 合成失败: ${result.error}`, 'error');
                    }
                } catch (error) {
                    addLog('ttsResults', `❌ 文本 ${i + 1} 请求异常: ${error.message}`, 'error');
                }
                
                // 添加延时避免请求过快
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            addLog('ttsResults', '基础TTS测试完成', 'info');
        }

        async function testCosyVoiceClone() {
            addLog('ttsResults', '开始CosyVoice声音克隆测试...', 'info');
            
            const testTexts = [
                '哈啰啊，这是声音克隆测试',
                '小智的声音克隆功能正常运行',
                'CosyVoice声音克隆效果展示'
            ];
            
            for (let i = 0; i < testTexts.length; i++) {
                const text = testTexts[i];
                addLog('ttsResults', `克隆测试 ${i + 1}: "${text}"`, 'info');
                
                try {
                    const result = await performTTSRequest(text, 'cosyvoice_clone');
                    if (result.success) {
                        addLog('ttsResults', `✅ 克隆测试 ${i + 1} 成功`, 'success');
                        if (result.audioUrl) {
                            showAudioPlayer(result.audioUrl);
                        }
                    } else {
                        addLog('ttsResults', `❌ 克隆测试 ${i + 1} 失败: ${result.error}`, 'error');
                    }
                } catch (error) {
                    addLog('ttsResults', `❌ 克隆测试 ${i + 1} 异常: ${error.message}`, 'error');
                }
                
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            addLog('ttsResults', 'CosyVoice声音克隆测试完成', 'info');
        }

        async function testCustomText() {
            const customText = document.getElementById('customTTSText').value.trim();
            
            if (!customText) {
                alert('请输入自定义测试文本');
                return;
            }
            
            addLog('ttsResults', `开始自定义文本测试: "${customText}"`, 'info');
            
            try {
                const result = await performTTSRequest(customText, 'custom');
                if (result.success) {
                    addLog('ttsResults', '✅ 自定义文本合成成功', 'success');
                    if (result.audioUrl) {
                        showAudioPlayer(result.audioUrl);
                    }
                } else {
                    addLog('ttsResults', `❌ 自定义文本合成失败: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog('ttsResults', `❌ 自定义文本请求异常: ${error.message}`, 'error');
            }
        }

        async function performTTSRequest(text, testType) {
            const startTime = Date.now();
            
            try {
                const httpBase = window.CURRENT_HTTP_API_BASE || HTTP_API_BASE;
                const response = await fetch(`${httpBase}/xiaozhi/api/tts/synthesize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        device_mac: currentDevice?.mac,
                        test_type: testType,
                        provider: testType === 'cosyvoice_clone' ? 'CosyVoiceClone' : 'default'
                    })
                });
                
                const duration = Date.now() - startTime;
                addLog('ttsResults', `请求耗时: ${duration}ms`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    return {
                        success: true,
                        audioUrl: result.audio_url,
                        duration: duration
                    };
                } else {
                    const errorText = await response.text();
                    return {
                        success: false,
                        error: `HTTP ${response.status}: ${errorText}`,
                        duration: duration
                    };
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                return {
                    success: false,
                    error: error.message,
                    duration: duration
                };
            }
        }

        function showAudioPlayer(audioUrl) {
            const audioControls = document.getElementById('audioControls');
            const audioPlayer = document.getElementById('audioPlayer');
            
            audioPlayer.src = audioUrl;
            audioControls.classList.remove('hidden');
            
            addLog('ttsResults', `音频文件: ${audioUrl}`, 'success');
        }

        function downloadAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer.src) {
                const link = document.createElement('a');
                link.href = audioPlayer.src;
                link.download = `tts_test_${Date.now()}.wav`;
                link.click();
            }
        }

        async function testDevicePing() {
            addLog('commResults', '开始设备连接测试...', 'info');
            
            if (!currentDevice) {
                addLog('commResults', '❌ 请先连接设备', 'error');
                return;
            }
            
            const pingMessage = {
                type: 'ping',
                mac: currentDevice.mac,
                timestamp: Date.now()
            };
            
            if (sendWebSocketMessage(pingMessage)) {
                addLog('commResults', '✅ Ping消息已发送', 'success');
            }
        }

        async function testDeviceWakeup() {
            addLog('commResults', '开始设备唤醒测试...', 'info');
            
            if (!currentDevice) {
                addLog('commResults', '❌ 请先连接设备', 'error');
                return;
            }
            
            const wakeupMessage = {
                type: 'wakeup_test',
                mac: currentDevice.mac,
                text: '你好小智，唤醒测试'
            };
            
            if (sendWebSocketMessage(wakeupMessage)) {
                addLog('commResults', '✅ 唤醒测试消息已发送', 'success');
            }
        }

        async function testDeviceRestart() {
            if (!confirm('确定要重启设备吗？这将断开当前连接。')) {
                return;
            }
            
            addLog('commResults', '发送设备重启指令...', 'warning');
            
            const restartMessage = {
                type: 'device_restart',
                mac: currentDevice.mac
            };
            
            if (sendWebSocketMessage(restartMessage)) {
                addLog('commResults', '✅ 重启指令已发送', 'success');
                addLog('commResults', '⏳ 设备将在几秒后重启...', 'warning');
            }
        }

        async function runFullTest() {
            addLog('fullTestResults', '🚀 开始运行完整功能测试...', 'info');
            
            // 清除之前的结果
            testResults.full = [];
            
            // 1. 连接测试
            addLog('fullTestResults', '1️⃣ 设备连接测试', 'info');
            await testDevicePing();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 2. TTS测试
            addLog('fullTestResults', '2️⃣ TTS功能测试', 'info');
            await testTTS();
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // 3. CosyVoice克隆测试
            addLog('fullTestResults', '3️⃣ CosyVoice声音克隆测试', 'info');
            await testCosyVoiceClone();
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // 4. 唤醒测试
            addLog('fullTestResults', '4️⃣ 设备唤醒测试', 'info');
            await testDeviceWakeup();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            addLog('fullTestResults', '✅ 完整功能测试完成！', 'success');
            
            // 生成测试报告
            generateTestReport();
        }

        function generateTestReport() {
            const report = {
                device: currentDevice,
                timestamp: new Date().toISOString(),
                duration: connectionStartTime ? Math.floor((Date.now() - connectionStartTime.getTime()) / 1000) : 0,
                messagesSent: messagesSent,
                messagesReceived: messagesReceived,
                testResults: testResults
            };
            
            addLog('fullTestResults', '📊 测试报告已生成', 'success');
            addLog('fullTestResults', `设备: ${report.device?.mac || '未知'}`, 'info');
            addLog('fullTestResults', `测试时长: ${formatDuration(report.duration)}`, 'info');
            addLog('fullTestResults', `消息统计: 发送${report.messagesSent} 接收${report.messagesReceived}`, 'info');
            
            // 保存报告到全局变量，供导出使用
            window.lastTestReport = report;
        }

        function exportTestReport() {
            if (!window.lastTestReport) {
                alert('没有可导出的测试报告，请先运行完整测试');
                return;
            }
            
            const reportJson = JSON.stringify(window.lastTestReport, null, 2);
            const blob = new Blob([reportJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `xiaozhi_test_report_${currentDevice?.mac || 'unknown'}_${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            addLog('fullTestResults', '✅ 测试报告已导出', 'success');
        }

        function clearDevice() {
            if (websocket) {
                clearPingKeepAlive(); // 清理定时器
                websocket.close();
            }
            
            currentDevice = null;
            connectionStartTime = null;
            messagesSent = 0;
            messagesReceived = 0;
            
            document.getElementById('deviceMac').value = '';
            document.getElementById('deviceInfoCard').classList.add('hidden');
            document.getElementById('audioControls').classList.add('hidden');
            
            updateStatus('wsStatus', '断开', 'offline');
            updateStatus('deviceStatus', '未知', 'unknown');
            
            document.getElementById('messagesSent').textContent = '0';
            document.getElementById('messagesReceived').textContent = '0';
            document.getElementById('connectionDuration').textContent = '--';
            
            addLog('commResults', '设备连接已清除', 'info');
        }

        function clearTTSResults() {
            document.getElementById('ttsResults').innerHTML = '<div class="log-info">等待测试...</div>';
            document.getElementById('audioControls').classList.add('hidden');
            testResults.tts = [];
        }

        function clearCommResults() {
            document.getElementById('commResults').innerHTML = '<div class="log-info">等待测试...</div>';
            testResults.communication = [];
        }

        function clearAllResults() {
            clearTTSResults();
            clearCommResults();
            document.getElementById('fullTestResults').innerHTML = '<div class="log-info">等待测试...</div>';
            testResults = { tts: [], communication: [], full: [] };
            window.lastTestReport = null;
        }

        // 页面关闭时清理WebSocket连接
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>

</html>
