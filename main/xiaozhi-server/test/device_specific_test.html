<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºè®¾å¤‡ä¸“é¡¹æµ‹è¯•é¡µé¢</title>
    
    <!-- æ·»åŠ favicon -->
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
    
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }

        .device-selector {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .device-selector h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
        }

        .device-input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .device-input-group label {
            font-weight: 500;
            min-width: 80px;
        }

        .device-input-group input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }

        .device-input-group button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .device-input-group button:hover {
            background: white;
            color: #f5576c;
        }

        .status-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #007bff;
        }

        .status-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
        }

        .status-label {
            font-weight: 500;
            color: #666;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: #28a745;
        }

        .status-offline {
            background-color: #dc3545;
        }

        .status-unknown {
            background-color: #ffc107;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .test-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .test-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .test-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .test-btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .test-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }

        .test-btn-secondary {
            background: linear-gradient(135deg, #6c757d, #545b62);
            color: white;
        }

        .test-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .test-btn-danger {
            background: linear-gradient(135deg, #dc3545, #b21e2f);
            color: white;
        }

        .test-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .test-results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #dee2e6;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .log-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }

        .log-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .log-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .log-error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .audio-player {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .device-info-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .device-info-card h3 {
            margin: 0 0 15px 0;
        }

        .device-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .device-detail {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
        }

        .device-detail-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .device-detail-value {
            font-weight: 600;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¤– å°æ™ºè®¾å¤‡ä¸“é¡¹æµ‹è¯•</h1>
        
        <!-- è®¾å¤‡é€‰æ‹©å™¨ -->
        <div class="device-selector">
            <h2>ğŸ” è®¾å¤‡é€‰æ‹©</h2>
            <div class="device-input-group">
                <label for="deviceMac">è®¾å¤‡MAC:</label>
                <input type="text" id="deviceMac" placeholder="ä¾‹å¦‚: 24:0A:C4:1D:3B:F0" 
                       pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                <button onclick="connectToDevice()">è¿æ¥è®¾å¤‡</button>
                <button onclick="clearDevice()">æ¸…é™¤</button>
            </div>
        </div>

        <!-- è¿æ¥é…ç½® -->
        <div class="device-selector" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <h2>âš™ï¸ è¿æ¥é…ç½®</h2>
            <div class="device-input-group">
                <label for="configHost">æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="configHost" placeholder="20.64.152.107" style="min-width: 150px;">
                <label for="configWsPort">WSç«¯å£:</label>
                <input type="text" id="configWsPort" placeholder="8000" style="min-width: 80px;">
                <label for="configHttpPort">HTTPç«¯å£:</label>
                <input type="text" id="configHttpPort" placeholder="8002" style="min-width: 80px;">
                <button onclick="updateConnectionConfig()">åº”ç”¨é…ç½®</button>
            </div>
            <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                å½“å‰WebSocket: <span id="currentWsUrl">--</span> | HTTP API: <span id="currentHttpUrl">--</span>
            </div>
        </div>

        <!-- è®¾å¤‡ä¿¡æ¯å¡ç‰‡ -->
        <div id="deviceInfoCard" class="device-info-card hidden">
            <h3>ğŸ“± è®¾å¤‡ä¿¡æ¯</h3>
            <div class="device-details">
                <div class="device-detail">
                    <div class="device-detail-label">MACåœ°å€</div>
                    <div class="device-detail-value" id="deviceMacDisplay">--</div>
                </div>
                <div class="device-detail">
                    <div class="device-detail-label">è¿æ¥çŠ¶æ€</div>
                    <div class="device-detail-value" id="deviceStatus">
                        <span class="status-indicator status-unknown"></span>æœªçŸ¥
                    </div>
                </div>
                <div class="device-detail">
                    <div class="device-detail-label">å›ºä»¶ç‰ˆæœ¬</div>
                    <div class="device-detail-value" id="deviceVersion">--</div>
                </div>
                <div class="device-detail">
                    <div class="device-detail-label">æœ€åæ´»è·ƒ</div>
                    <div class="device-detail-value" id="deviceLastSeen">--</div>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€ç›‘æ§ -->
        <div class="status-section">
            <div class="status-card">
                <h3>ğŸŒ æœåŠ¡å™¨çŠ¶æ€</h3>
                <div class="status-info">
                    <span class="status-label">WebSocket:</span>
                    <span class="status-value" id="wsStatus">
                        <span class="status-indicator status-offline"></span>æ–­å¼€
                    </span>
                </div>
                <div class="status-info">
                    <span class="status-label">HTTP API:</span>
                    <span class="status-value" id="httpStatus">
                        <span class="status-indicator status-unknown"></span>æœªçŸ¥
                    </span>
                </div>
                <div class="status-info">
                    <span class="status-label">æœåŠ¡å™¨æ—¶é—´:</span>
                    <span class="status-value" id="serverTime">--</span>
                </div>
            </div>

            <div class="status-card">
                <h3>ğŸ“Š è®¾å¤‡çŠ¶æ€</h3>
                <div class="status-info">
                    <span class="status-label">è¿æ¥æ—¶é•¿:</span>
                    <span class="status-value" id="connectionDuration">--</span>
                </div>
                <div class="status-info">
                    <span class="status-label">æ¶ˆæ¯å‘é€:</span>
                    <span class="status-value" id="messagesSent">0</span>
                </div>
                <div class="status-info">
                    <span class="status-label">æ¶ˆæ¯æ¥æ”¶:</span>
                    <span class="status-value" id="messagesReceived">0</span>
                </div>
            </div>
        </div>

        <!-- TTSæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸµ TTSè¯­éŸ³åˆæˆæµ‹è¯•</h3>
            <div class="test-controls">
                <button class="test-btn test-btn-primary" onclick="testTTS()">åŸºç¡€TTSæµ‹è¯•</button>
                <button class="test-btn test-btn-primary" onclick="testCosyVoiceClone()">CosyVoiceå…‹éš†æµ‹è¯•</button>
                <button class="test-btn test-btn-secondary" onclick="testCustomText()">è‡ªå®šä¹‰æ–‡æœ¬æµ‹è¯•</button>
                <button class="test-btn test-btn-danger" onclick="clearTTSResults()">æ¸…é™¤ç»“æœ</button>
            </div>
            <div>
                <label for="customTTSText">è‡ªå®šä¹‰æµ‹è¯•æ–‡æœ¬:</label>
                <input type="text" id="customTTSText" placeholder="è¾“å…¥è¦æµ‹è¯•çš„æ–‡æœ¬..." style="width: 100%; margin: 10px 0; padding: 8px;">
            </div>
            <div class="test-results" id="ttsResults">
                <div class="log-info">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            <div class="audio-controls hidden" id="audioControls">
                <label>ç”Ÿæˆçš„éŸ³é¢‘:</label>
                <audio class="audio-player" id="audioPlayer" controls></audio>
                <button class="test-btn test-btn-secondary" onclick="downloadAudio()">ä¸‹è½½éŸ³é¢‘</button>
            </div>
        </div>

        <!-- è®¾å¤‡é€šä¿¡æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“¡ è®¾å¤‡é€šä¿¡æµ‹è¯•</h3>
            <div class="test-controls">
                <button class="test-btn test-btn-primary" onclick="testDevicePing()">è¿æ¥æµ‹è¯•</button>
                <button class="test-btn test-btn-primary" onclick="testDeviceWakeup()">å”¤é†’æµ‹è¯•</button>
                <button class="test-btn test-btn-secondary" onclick="testDeviceRestart()">é‡å¯è®¾å¤‡</button>
                <button class="test-btn test-btn-danger" onclick="clearCommResults()">æ¸…é™¤ç»“æœ</button>
            </div>
            <div class="test-results" id="commResults">
                <div class="log-info">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>

        <!-- å®Œæ•´åŠŸèƒ½æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸš€ å®Œæ•´åŠŸèƒ½æµ‹è¯•</h3>
            <div class="test-controls">
                <button class="test-btn test-btn-primary" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <button class="test-btn test-btn-secondary" onclick="exportTestReport()">å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š</button>
                <button class="test-btn test-btn-danger" onclick="clearAllResults()">æ¸…é™¤æ‰€æœ‰ç»“æœ</button>
            </div>
            <div class="test-results" id="fullTestResults">
                <div class="log-info">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let websocket = null;
        let currentDevice = null;
        let testResults = {
            tts: [],
            communication: [],
            full: []
        };
        let connectionStartTime = null;
        let messagesSent = 0;
        let messagesReceived = 0;
        let pingInterval = null; // ä¿æ´»å®šæ—¶å™¨

    // ===================== å¯é…ç½®è¿æ¥å‚æ•° =====================
    // é€šè¿‡ URL å‚æ•°è‡ªå®šä¹‰: ?host=20.64.152.107&ws_port=8000&http_port=8002
    // ä¹Ÿå¯ç›´æ¥ä¼ å®Œæ•´ ws åŸºç¡€åœ°å€: ?ws_base=ws://example.com:8001/xiaozhi/v1/
    // å¦‚æœæ—¢ä¼  ws_base ä¹Ÿä¼  host/ws_portï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ ws_base
    const pageParams = new URLSearchParams(window.location.search);
    const DEFAULT_HOST = window.location.hostname || '20.64.152.107';
    const HOST = pageParams.get('host') || DEFAULT_HOST;
    const WS_PORT = pageParams.get('ws_port') || '8000'; // ç›´è¿åç«¯é»˜è®¤ 8000; è‹¥èµ° nginx å¯æ”¹ 8001
    const HTTP_PORT = pageParams.get('http_port') || '8002'; // manager-api / æˆ– nginx ç«¯å£
    const WS_BASE = pageParams.get('ws_base') || `ws://${HOST}:${WS_PORT}/xiaozhi/v1/`;
    const HTTP_API_BASE = pageParams.get('http_base') || `http://${HOST}:${HTTP_PORT}`;
    // å½“å‰å®é™…ä½¿ç”¨çš„ WebSocket å®Œæ•´åœ°å€åœ¨å»ºç«‹è¿æ¥æ—¶æ‹¼æ¥ device-id & client-id æŸ¥è¯¢å‚æ•°
    // ==========================================================

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeUI();
            initializeConnectionConfig();
            checkServerStatus();
            
            // ä»URLå‚æ•°ä¸­è·å–MACåœ°å€
            const urlParams = new URLSearchParams(window.location.search);
            const macParam = urlParams.get('mac');
            if (macParam) {
                document.getElementById('deviceMac').value = macParam;
                connectToDevice();
            }
        });

        function initializeUI() {
            // è®¾ç½®å®æ—¶æ—¶é—´æ›´æ–°
            setInterval(updateServerTime, 1000);
            
            // ç›‘å¬MACåœ°å€è¾“å…¥æ ¼å¼åŒ–
            const macInput = document.getElementById('deviceMac');
            macInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9A-Fa-f]/g, '');
                let formatted = value.match(/.{1,2}/g)?.join(':') || value;
                if (formatted.length <= 17) {
                    e.target.value = formatted.toUpperCase();
                }
            });
        }

        function initializeConnectionConfig() {
            // è®¾ç½®é»˜è®¤é…ç½®
            document.getElementById('configHost').value = HOST;
            document.getElementById('configWsPort').value = WS_PORT;
            document.getElementById('configHttpPort').value = HTTP_PORT;
            
            // æ›´æ–°æ˜¾ç¤º
            updateConnectionConfigDisplay();
        }

        function updateConnectionConfig() {
            const newHost = document.getElementById('configHost').value.trim() || HOST;
            const newWsPort = document.getElementById('configWsPort').value.trim() || WS_PORT;
            const newHttpPort = document.getElementById('configHttpPort').value.trim() || HTTP_PORT;
            
            // æ›´æ–°å…¨å±€å˜é‡ï¼ˆé‡æ–°èµ‹å€¼å¸¸é‡ï¼‰
            window.CURRENT_HOST = newHost;
            window.CURRENT_WS_PORT = newWsPort;
            window.CURRENT_HTTP_PORT = newHttpPort;
            window.CURRENT_WS_BASE = `ws://${newHost}:${newWsPort}/xiaozhi/v1/`;
            window.CURRENT_HTTP_API_BASE = `http://${newHost}:${newHttpPort}`;
            
            updateConnectionConfigDisplay();
            addLog('commResults', `è¿æ¥é…ç½®å·²æ›´æ–°: WS=${newHost}:${newWsPort}, HTTP=${newHost}:${newHttpPort}`, 'success');
        }

        function updateConnectionConfigDisplay() {
            const wsBase = window.CURRENT_WS_BASE || WS_BASE;
            const httpBase = window.CURRENT_HTTP_API_BASE || HTTP_API_BASE;
            document.getElementById('currentWsUrl').textContent = wsBase;
            document.getElementById('currentHttpUrl').textContent = httpBase;
        }

        function updateServerTime() {
            const now = new Date();
            document.getElementById('serverTime').textContent = now.toLocaleString();
        }

        function addLog(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        async function checkServerStatus() {
            try {
                const httpBase = window.CURRENT_HTTP_API_BASE || HTTP_API_BASE;
                const response = await fetch(`${httpBase}/xiaozhi/health`);
                if (response.ok) {
                    updateStatus('httpStatus', 'åœ¨çº¿', 'online');
                } else {
                    updateStatus('httpStatus', 'é”™è¯¯', 'offline');
                }
            } catch (error) {
                updateStatus('httpStatus', 'ç¦»çº¿', 'offline');
            }
        }

        function updateStatus(elementId, text, status) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            
            element.innerHTML = `<span class="status-indicator status-${status}"></span>${text}`;
        }

        function connectToDevice() {
            const macAddress = document.getElementById('deviceMac').value.trim();
            
            if (!macAddress) {
                alert('è¯·è¾“å…¥è®¾å¤‡MACåœ°å€');
                return;
            }

            if (!isValidMacAddress(macAddress)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„MACåœ°å€æ ¼å¼ (ä¾‹å¦‚: 24:0A:C4:1D:3B:F0)');
                return;
            }

            currentDevice = {
                mac: macAddress,
                status: 'connecting'
            };

            // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯å¡ç‰‡
            showDeviceInfo();
            
            // å»ºç«‹WebSocketè¿æ¥
            connectWebSocket();
            
            addLog('commResults', `å¼€å§‹è¿æ¥è®¾å¤‡: ${macAddress}`, 'info');
        }

        function isValidMacAddress(mac) {
            const macPattern = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
            return macPattern.test(mac);
        }

        function showDeviceInfo() {
            const card = document.getElementById('deviceInfoCard');
            card.classList.remove('hidden');
            
            document.getElementById('deviceMacDisplay').textContent = currentDevice.mac;
            updateStatus('deviceStatus', 'è¿æ¥ä¸­...', 'unknown');
        }

        function connectWebSocket() {
            if (websocket) {
                clearPingKeepAlive(); // æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨
                websocket.close();
            }
            
            // ç”Ÿæˆ client-idï¼ˆé¿å…é‡å¤ï¼‰
            const clientId = `web_${Date.now().toString(36)}`;
            // ä½¿ç”¨å½“å‰é…ç½®çš„åœ°å€
            const wsBase = window.CURRENT_WS_BASE || WS_BASE;
            // å¿…é¡»æºå¸¦ device-id ä¸ client-id æŸ¥è¯¢å‚æ•°ï¼Œå¦åˆ™æœåŠ¡å™¨ä¼šç«‹å³å…³é—­è¿æ¥
            const fullWsUrl = `${wsBase}?device-id=${encodeURIComponent(currentDevice.mac)}&client-id=${encodeURIComponent(clientId)}`;
            addLog('commResults', `å°è¯•è¿æ¥: ${fullWsUrl}`, 'info');
            try {
                websocket = new WebSocket(fullWsUrl);
            } catch (e) {
                addLog('commResults', `åˆ›å»ºWebSocketå¤±è´¥: ${e.message}`, 'error');
                updateStatus('wsStatus', 'é”™è¯¯', 'offline');
                return;
            }
            connectionStartTime = new Date();

            websocket.onopen = function() {
                updateStatus('wsStatus', 'å·²è¿æ¥', 'online');
                addLog('commResults', 'WebSocketè¿æ¥æˆåŠŸ', 'success');
                
                // å‘é€æ ‡å‡† hello æ¶ˆæ¯ï¼ˆæ¨¡æ‹ŸçœŸå®è®¾å¤‡è¡Œä¸ºï¼‰
                sendHelloMessage();
                
                // å¯åŠ¨å®šæ—¶ ping ä¿æ´»
                startPingKeepAlive();
            };

            websocket.onmessage = function(event) {
                messagesReceived++;
                document.getElementById('messagesReceived').textContent = messagesReceived;
                
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    addLog('commResults', `æ¶ˆæ¯è§£æé”™è¯¯: ${error.message}`, 'error');
                }
            };

            websocket.onclose = function(event) {
                updateStatus('wsStatus', 'å·²æ–­å¼€', 'offline');
                updateStatus('deviceStatus', 'ç¦»çº¿', 'offline');
                
                // æ˜¾ç¤ºè¯¦ç»†çš„å…³é—­ä¿¡æ¯
                const closeReason = getCloseReason(event.code);
                addLog('commResults', `WebSocketè¿æ¥æ–­å¼€ - ä»£ç : ${event.code}, åŸå› : ${closeReason}`, 'warning');
                if (event.reason) {
                    addLog('commResults', `æœåŠ¡å™¨æ¶ˆæ¯: ${event.reason}`, 'info');
                }
                
                // æ¸…ç†å®šæ—¶å™¨
                clearPingKeepAlive();
            };

            websocket.onerror = function(error) {
                addLog('commResults', `WebSocketé”™è¯¯: ${error}`, 'error');
                updateStatus('wsStatus', 'é”™è¯¯', 'offline');
            };
        }

        function sendDeviceAuth() {
            const authMessage = {
                type: 'device_auth',
                mac: currentDevice.mac,
                timestamp: Date.now()
            };
            
            sendWebSocketMessage(authMessage);
            addLog('commResults', 'å‘é€è®¾å¤‡è®¤è¯è¯·æ±‚', 'info');
        }

        function sendHelloMessage() {
            const helloMessage = {
                type: 'hello',
                device_id: currentDevice.mac,
                device_name: 'Webæµ‹è¯•è®¾å¤‡',
                device_mac: currentDevice.mac,
                token: 'your-token1',
                features: { mcp: true }
            };
            
            if (sendWebSocketMessage(helloMessage)) {
                addLog('commResults', 'å‘é€helloåˆå§‹åŒ–æ¶ˆæ¯', 'success');
            }
        }

        function startPingKeepAlive() {
            // æ¯30ç§’å‘é€ä¸€æ¬¡pingä¿æ´»
            pingInterval = setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    const pingMessage = {
                        type: 'ping',
                        timestamp: Date.now()
                    };
                    sendWebSocketMessage(pingMessage);
                    addLog('commResults', 'å‘é€pingä¿æ´»', 'info');
                }
            }, 30000);
        }

        function clearPingKeepAlive() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }

        function getCloseReason(code) {
            const reasons = {
                1000: 'æ­£å¸¸å…³é—­',
                1001: 'ç«¯ç‚¹ç¦»å¼€',
                1002: 'åè®®é”™è¯¯',
                1003: 'ä¸æ”¯æŒçš„æ•°æ®ç±»å‹',
                1005: 'æ²¡æœ‰çŠ¶æ€ç ',
                1006: 'å¼‚å¸¸å…³é—­',
                1007: 'æ— æ•ˆæ•°æ®',
                1008: 'è¿åç­–ç•¥',
                1009: 'æ¶ˆæ¯è¿‡å¤§',
                1010: 'æ‰©å±•é”™è¯¯',
                1011: 'æœåŠ¡å™¨é”™è¯¯',
                1012: 'æœåŠ¡é‡å¯',
                1013: 'ç¨åé‡è¯•',
                1014: 'ç½‘å…³é”™è¯¯',
                1015: 'TLSæ¡æ‰‹å¤±è´¥'
            };
            return reasons[code] || `æœªçŸ¥é”™è¯¯ç : ${code}`;
        }

        function sendWebSocketMessage(message) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify(message));
                messagesSent++;
                document.getElementById('messagesSent').textContent = messagesSent;
                return true;
            } else {
                addLog('commResults', 'WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
                return false;
            }
        }

        function handleWebSocketMessage(data) {
            addLog('commResults', `æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');
            
            switch (data.type) {
                case 'device_auth_response':
                    if (data.success) {
                        updateStatus('deviceStatus', 'å·²è®¤è¯', 'online');
                        currentDevice.status = 'authenticated';
                        addLog('commResults', 'è®¾å¤‡è®¤è¯æˆåŠŸ', 'success');
                    } else {
                        updateStatus('deviceStatus', 'è®¤è¯å¤±è´¥', 'offline');
                        addLog('commResults', `è®¾å¤‡è®¤è¯å¤±è´¥: ${data.message}`, 'error');
                    }
                    break;
                    
                case 'device_info':
                    updateDeviceInfo(data);
                    break;
                    
                case 'tts_response':
                    handleTTSResponse(data);
                    break;

                case 'welcome':
                case 'session_start':
                    updateStatus('deviceStatus', 'ä¼šè¯å·²å»ºç«‹', 'online');
                    addLog('commResults', 'æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯ï¼Œä¼šè¯å»ºç«‹æˆåŠŸ', 'success');
                    break;

                case 'pong':
                    addLog('commResults', 'æ”¶åˆ°pongå“åº”', 'info');
                    break;

                case 'mcp':
                    // å¤„ç†MCPæ¶ˆæ¯
                    handleMCPMessage(data);
                    break;
                    
                default:
                    addLog('commResults', `æ”¶åˆ°æ¶ˆæ¯ç±»å‹: ${data.type}`, 'info');
            }
        }

        function handleMCPMessage(data) {
            addLog('commResults', 'æ”¶åˆ°MCPæ¶ˆæ¯ï¼Œå‘é€å“åº”', 'info');
            
            if (data.payload && data.payload.method) {
                switch (data.payload.method) {
                    case 'initialize':
                        // å“åº”åˆå§‹åŒ–
                        const initResponse = {
                            type: 'mcp',
                            payload: {
                                jsonrpc: '2.0',
                                id: data.payload.id,
                                result: {
                                    protocolVersion: '2024-11-05',
                                    capabilities: {
                                        tools: {},
                                        resources: {},
                                        prompts: {}
                                    },
                                    serverInfo: {
                                        name: 'WebTestDevice',
                                        version: '1.0.0'
                                    }
                                }
                            }
                        };
                        sendWebSocketMessage(initResponse);
                        addLog('commResults', 'å·²å“åº”MCPåˆå§‹åŒ–', 'success');
                        break;

                    case 'tools/list':
                        // è¿”å›è®¾å¤‡æ”¯æŒçš„å·¥å…·åˆ—è¡¨
                        const toolsResponse = {
                            type: 'mcp',
                            payload: {
                                jsonrpc: '2.0',
                                id: data.payload.id,
                                result: {
                                    tools: [
                                        {
                                            name: 'self.get_device_status',
                                            description: 'è·å–è®¾å¤‡çŠ¶æ€ä¿¡æ¯',
                                            inputSchema: {
                                                type: 'object',
                                                properties: {}
                                            }
                                        },
                                        {
                                            name: 'self.audio_speaker_set_volume',
                                            description: 'è®¾ç½®éŸ³é‡',
                                            inputSchema: {
                                                type: 'object',
                                                properties: {
                                                    volume: {
                                                        type: 'number',
                                                        description: 'éŸ³é‡å€¼ 0-100'
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        };
                        sendWebSocketMessage(toolsResponse);
                        addLog('commResults', 'å·²å“åº”å·¥å…·åˆ—è¡¨', 'success');
                        updateStatus('deviceStatus', 'å·²è¿æ¥', 'online');
                        break;

                    default:
                        addLog('commResults', `æœªå¤„ç†çš„MCPæ–¹æ³•: ${data.payload.method}`, 'warning');
                }
            }
        }

        function updateDeviceInfo(data) {
            if (data.version) {
                document.getElementById('deviceVersion').textContent = data.version;
            }
            if (data.lastSeen) {
                document.getElementById('deviceLastSeen').textContent = new Date(data.lastSeen).toLocaleString();
            }
            
            // æ›´æ–°è¿æ¥æ—¶é•¿
            if (connectionStartTime) {
                const duration = Math.floor((Date.now() - connectionStartTime.getTime()) / 1000);
                document.getElementById('connectionDuration').textContent = formatDuration(duration);
            }
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†${secs}ç§’`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }

        async function testTTS() {
            addLog('ttsResults', 'å¼€å§‹åŸºç¡€TTSæµ‹è¯•...', 'info');
            
            const testTexts = [
                'ä½ å¥½ï¼Œæˆ‘æ˜¯å°æ™ºåŠ©æ‰‹',
                'ä»Šå¤©å¤©æ°”å¾ˆå¥½',
                'è¯­éŸ³åˆæˆæµ‹è¯•æˆåŠŸ'
            ];
            
            for (let i = 0; i < testTexts.length; i++) {
                const text = testTexts[i];
                addLog('ttsResults', `æµ‹è¯•æ–‡æœ¬ ${i + 1}: "${text}"`, 'info');
                
                try {
                    const result = await performTTSRequest(text, 'basic');
                    if (result.success) {
                        addLog('ttsResults', `âœ… æ–‡æœ¬ ${i + 1} åˆæˆæˆåŠŸ`, 'success');
                        if (result.audioUrl) {
                            showAudioPlayer(result.audioUrl);
                        }
                    } else {
                        addLog('ttsResults', `âŒ æ–‡æœ¬ ${i + 1} åˆæˆå¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    addLog('ttsResults', `âŒ æ–‡æœ¬ ${i + 1} è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                }
                
                // æ·»åŠ å»¶æ—¶é¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            addLog('ttsResults', 'åŸºç¡€TTSæµ‹è¯•å®Œæˆ', 'info');
        }

        async function testCosyVoiceClone() {
            addLog('ttsResults', 'å¼€å§‹CosyVoiceå£°éŸ³å…‹éš†æµ‹è¯•...', 'info');
            
            const testTexts = [
                'å“ˆå•°å•Šï¼Œè¿™æ˜¯å£°éŸ³å…‹éš†æµ‹è¯•',
                'å°æ™ºçš„å£°éŸ³å…‹éš†åŠŸèƒ½æ­£å¸¸è¿è¡Œ',
                'CosyVoiceå£°éŸ³å…‹éš†æ•ˆæœå±•ç¤º'
            ];
            
            for (let i = 0; i < testTexts.length; i++) {
                const text = testTexts[i];
                addLog('ttsResults', `å…‹éš†æµ‹è¯• ${i + 1}: "${text}"`, 'info');
                
                try {
                    const result = await performTTSRequest(text, 'cosyvoice_clone');
                    if (result.success) {
                        addLog('ttsResults', `âœ… å…‹éš†æµ‹è¯• ${i + 1} æˆåŠŸ`, 'success');
                        if (result.audioUrl) {
                            showAudioPlayer(result.audioUrl);
                        }
                    } else {
                        addLog('ttsResults', `âŒ å…‹éš†æµ‹è¯• ${i + 1} å¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    addLog('ttsResults', `âŒ å…‹éš†æµ‹è¯• ${i + 1} å¼‚å¸¸: ${error.message}`, 'error');
                }
                
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            addLog('ttsResults', 'CosyVoiceå£°éŸ³å…‹éš†æµ‹è¯•å®Œæˆ', 'info');
        }

        async function testCustomText() {
            const customText = document.getElementById('customTTSText').value.trim();
            
            if (!customText) {
                alert('è¯·è¾“å…¥è‡ªå®šä¹‰æµ‹è¯•æ–‡æœ¬');
                return;
            }
            
            addLog('ttsResults', `å¼€å§‹è‡ªå®šä¹‰æ–‡æœ¬æµ‹è¯•: "${customText}"`, 'info');
            
            try {
                const result = await performTTSRequest(customText, 'custom');
                if (result.success) {
                    addLog('ttsResults', 'âœ… è‡ªå®šä¹‰æ–‡æœ¬åˆæˆæˆåŠŸ', 'success');
                    if (result.audioUrl) {
                        showAudioPlayer(result.audioUrl);
                    }
                } else {
                    addLog('ttsResults', `âŒ è‡ªå®šä¹‰æ–‡æœ¬åˆæˆå¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog('ttsResults', `âŒ è‡ªå®šä¹‰æ–‡æœ¬è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function performTTSRequest(text, testType) {
            const startTime = Date.now();
            
            try {
                const httpBase = window.CURRENT_HTTP_API_BASE || HTTP_API_BASE;
                const response = await fetch(`${httpBase}/xiaozhi/api/tts/synthesize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        device_mac: currentDevice?.mac,
                        test_type: testType,
                        provider: testType === 'cosyvoice_clone' ? 'CosyVoiceClone' : 'default'
                    })
                });
                
                const duration = Date.now() - startTime;
                addLog('ttsResults', `è¯·æ±‚è€—æ—¶: ${duration}ms`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    return {
                        success: true,
                        audioUrl: result.audio_url,
                        duration: duration
                    };
                } else {
                    const errorText = await response.text();
                    return {
                        success: false,
                        error: `HTTP ${response.status}: ${errorText}`,
                        duration: duration
                    };
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                return {
                    success: false,
                    error: error.message,
                    duration: duration
                };
            }
        }

        function showAudioPlayer(audioUrl) {
            const audioControls = document.getElementById('audioControls');
            const audioPlayer = document.getElementById('audioPlayer');
            
            audioPlayer.src = audioUrl;
            audioControls.classList.remove('hidden');
            
            addLog('ttsResults', `éŸ³é¢‘æ–‡ä»¶: ${audioUrl}`, 'success');
        }

        function downloadAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer.src) {
                const link = document.createElement('a');
                link.href = audioPlayer.src;
                link.download = `tts_test_${Date.now()}.wav`;
                link.click();
            }
        }

        async function testDevicePing() {
            addLog('commResults', 'å¼€å§‹è®¾å¤‡è¿æ¥æµ‹è¯•...', 'info');
            
            if (!currentDevice) {
                addLog('commResults', 'âŒ è¯·å…ˆè¿æ¥è®¾å¤‡', 'error');
                return;
            }
            
            const pingMessage = {
                type: 'ping',
                mac: currentDevice.mac,
                timestamp: Date.now()
            };
            
            if (sendWebSocketMessage(pingMessage)) {
                addLog('commResults', 'âœ… Pingæ¶ˆæ¯å·²å‘é€', 'success');
            }
        }

        async function testDeviceWakeup() {
            addLog('commResults', 'å¼€å§‹è®¾å¤‡å”¤é†’æµ‹è¯•...', 'info');
            
            if (!currentDevice) {
                addLog('commResults', 'âŒ è¯·å…ˆè¿æ¥è®¾å¤‡', 'error');
                return;
            }
            
            const wakeupMessage = {
                type: 'wakeup_test',
                mac: currentDevice.mac,
                text: 'ä½ å¥½å°æ™ºï¼Œå”¤é†’æµ‹è¯•'
            };
            
            if (sendWebSocketMessage(wakeupMessage)) {
                addLog('commResults', 'âœ… å”¤é†’æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'success');
            }
        }

        async function testDeviceRestart() {
            if (!confirm('ç¡®å®šè¦é‡å¯è®¾å¤‡å—ï¼Ÿè¿™å°†æ–­å¼€å½“å‰è¿æ¥ã€‚')) {
                return;
            }
            
            addLog('commResults', 'å‘é€è®¾å¤‡é‡å¯æŒ‡ä»¤...', 'warning');
            
            const restartMessage = {
                type: 'device_restart',
                mac: currentDevice.mac
            };
            
            if (sendWebSocketMessage(restartMessage)) {
                addLog('commResults', 'âœ… é‡å¯æŒ‡ä»¤å·²å‘é€', 'success');
                addLog('commResults', 'â³ è®¾å¤‡å°†åœ¨å‡ ç§’åé‡å¯...', 'warning');
            }
        }

        async function runFullTest() {
            addLog('fullTestResults', 'ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´åŠŸèƒ½æµ‹è¯•...', 'info');
            
            // æ¸…é™¤ä¹‹å‰çš„ç»“æœ
            testResults.full = [];
            
            // 1. è¿æ¥æµ‹è¯•
            addLog('fullTestResults', '1ï¸âƒ£ è®¾å¤‡è¿æ¥æµ‹è¯•', 'info');
            await testDevicePing();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 2. TTSæµ‹è¯•
            addLog('fullTestResults', '2ï¸âƒ£ TTSåŠŸèƒ½æµ‹è¯•', 'info');
            await testTTS();
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // 3. CosyVoiceå…‹éš†æµ‹è¯•
            addLog('fullTestResults', '3ï¸âƒ£ CosyVoiceå£°éŸ³å…‹éš†æµ‹è¯•', 'info');
            await testCosyVoiceClone();
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // 4. å”¤é†’æµ‹è¯•
            addLog('fullTestResults', '4ï¸âƒ£ è®¾å¤‡å”¤é†’æµ‹è¯•', 'info');
            await testDeviceWakeup();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            addLog('fullTestResults', 'âœ… å®Œæ•´åŠŸèƒ½æµ‹è¯•å®Œæˆï¼', 'success');
            
            // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
            generateTestReport();
        }

        function generateTestReport() {
            const report = {
                device: currentDevice,
                timestamp: new Date().toISOString(),
                duration: connectionStartTime ? Math.floor((Date.now() - connectionStartTime.getTime()) / 1000) : 0,
                messagesSent: messagesSent,
                messagesReceived: messagesReceived,
                testResults: testResults
            };
            
            addLog('fullTestResults', 'ğŸ“Š æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ', 'success');
            addLog('fullTestResults', `è®¾å¤‡: ${report.device?.mac || 'æœªçŸ¥'}`, 'info');
            addLog('fullTestResults', `æµ‹è¯•æ—¶é•¿: ${formatDuration(report.duration)}`, 'info');
            addLog('fullTestResults', `æ¶ˆæ¯ç»Ÿè®¡: å‘é€${report.messagesSent} æ¥æ”¶${report.messagesReceived}`, 'info');
            
            // ä¿å­˜æŠ¥å‘Šåˆ°å…¨å±€å˜é‡ï¼Œä¾›å¯¼å‡ºä½¿ç”¨
            window.lastTestReport = report;
        }

        function exportTestReport() {
            if (!window.lastTestReport) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æµ‹è¯•æŠ¥å‘Šï¼Œè¯·å…ˆè¿è¡Œå®Œæ•´æµ‹è¯•');
                return;
            }
            
            const reportJson = JSON.stringify(window.lastTestReport, null, 2);
            const blob = new Blob([reportJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `xiaozhi_test_report_${currentDevice?.mac || 'unknown'}_${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            addLog('fullTestResults', 'âœ… æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }

        function clearDevice() {
            if (websocket) {
                clearPingKeepAlive(); // æ¸…ç†å®šæ—¶å™¨
                websocket.close();
            }
            
            currentDevice = null;
            connectionStartTime = null;
            messagesSent = 0;
            messagesReceived = 0;
            
            document.getElementById('deviceMac').value = '';
            document.getElementById('deviceInfoCard').classList.add('hidden');
            document.getElementById('audioControls').classList.add('hidden');
            
            updateStatus('wsStatus', 'æ–­å¼€', 'offline');
            updateStatus('deviceStatus', 'æœªçŸ¥', 'unknown');
            
            document.getElementById('messagesSent').textContent = '0';
            document.getElementById('messagesReceived').textContent = '0';
            document.getElementById('connectionDuration').textContent = '--';
            
            addLog('commResults', 'è®¾å¤‡è¿æ¥å·²æ¸…é™¤', 'info');
        }

        function clearTTSResults() {
            document.getElementById('ttsResults').innerHTML = '<div class="log-info">ç­‰å¾…æµ‹è¯•...</div>';
            document.getElementById('audioControls').classList.add('hidden');
            testResults.tts = [];
        }

        function clearCommResults() {
            document.getElementById('commResults').innerHTML = '<div class="log-info">ç­‰å¾…æµ‹è¯•...</div>';
            testResults.communication = [];
        }

        function clearAllResults() {
            clearTTSResults();
            clearCommResults();
            document.getElementById('fullTestResults').innerHTML = '<div class="log-info">ç­‰å¾…æµ‹è¯•...</div>';
            testResults = { tts: [], communication: [], full: [] };
            window.lastTestReport = null;
        }

        // é¡µé¢å…³é—­æ—¶æ¸…ç†WebSocketè¿æ¥
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>

</html>
